======================================
LOGGING dello stato dell'orchestratore 
======================================

Il logging dello stato dell'orchestrare utilizza la seguente catena:

flusso mule ---(classe Logstash.java)---> LOG4J ---(socket appender)---> LOGSTASH ---> ELASTICSEARCH (indice rheticusorchestratorlog) ---> KIBANA

Quindi la catena prevede le seguenti componenti:

LOG4J:
	configurato con

	<Configuration>	
	    <Appenders>
	        <Socket name="logstash-socket" host="localhost" port="9500" protocol="tcp">
	        	<SerializedLayout/>
	        </Socket>
	    </Appenders>
	    <Loggers>
			<Logger name="it.planetek.rheticus.mule.components.Logstash" level="INFO">
				 <AppenderRef ref="logstash-socket"/>
			</Logger>        
	        
	        <Root level="INFO">
	            <AppenderRef ref="Console" />
	        </Root>        
	    </Loggers>
	</Configuration>
	
	
LOGSTASH 1.5.4
	installare il plugin di input per interfacciarsi con LOG4J2 
		$LS_HOME/bin/plugin install logstash-input-log4j2
		dove 
		$LS_HOME è la cartella dove si trova logstash

	configurato con il seguente file di conf:
		input {
		    log4j2 {
		        mode => "server"
		        host => "127.0.0.1"        
		        port => 9500
		    }
		}
		filter {
		    json {
		        source => "message"
		        target => "processorStatus"
		        #target => "msg"
		    }
		    mutate {
		        remove_field => [ "message","host","path","priority","logstash-socket","thread","class","file","method","logger_name" ]
		  	}
		}
		output {
		    # only for debug purposes
		    stdout {
		        codec => json
		    }
		    elasticsearch {
		        protocol => http
		        #host => "127.0.0.1"
		        host => localhost
		        port => 9200
		        index => rheticusorchestratorlog
		    } 
		}

	run logstash:
			bin/logstash -f <file conf>
	

FLUSSO MULE:
	nel flusso Mule per loggare è necessario inserire le seguenti istruzioni nel file xml:
	
	<set-variable doc:name="logstash" variableName="logstash" value="{&quot;processor&quot;: &quot;PS&quot;, &quot;orchestratorId&quot;:&quot;#[instanceId] &quot;, &quot;datasetId&quot;: &quot;XXXXXXX&quot;, &quot;step&quot;: &quot;L0&quot;, &quot;status&quot;: &quot;PROGRESS&quot;, &quot;message&quot;:&quot;Avvio ricerca Supermaster&quot;}" />
	<component class="it.planetek.rheticus.mule.components.Logstash" doc:name="Java"/>
	 
	 in questo caso viene loggato un documento JSON del tipo:
	 {"processor": "PS", "orchestratorId":"#[instanceId] ", "datasetId": "XXXXXXX", "step": "L0", "status": "PROGRESS", "message":"Avvio ricerca Supermaster"}
	